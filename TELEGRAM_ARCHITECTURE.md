# Архитектура Telegram бота

## Как работает Telegram бот

### 1. Webhook - точка входа
```
Пользователь → Telegram → Ваш сервер (webhook) → Ответ пользователю
```

**Текущая структура:**
```
POST /api/telegram/webhook
  ↓
TelegramController::webhook()
  ↓
handleMessage() или handleCallbackQuery()
  ↓
Обработка команды/кнопки
  ↓
Отправка ответа через TelegramService
```

### 2. Важное ограничение Telegram
⚠️ **Telegram требует ответа в течение 1 секунды!**

Если webhook не ответит быстро, Telegram будет повторять запрос.

### 3. Что можно делать в webhook (быстро):
✅ Отправка сообщений
✅ Сохранение в БД
✅ Показ баланса
✅ Простая валидация
✅ Обработка команд

### 4. Что НЕЛЬЗЯ делать в webhook (долго):
❌ Генерация видео (может занять минуты)
❌ Генерация изображений (может занять секунды)
❌ Долгие API запросы
❌ Обработка файлов

## Решение для долгих операций: Очереди (Queues)

### Схема с очередями:
```
Webhook (быстрый ответ) → Очередь → Фоновая обработка → Уведомление пользователю
```

### Пример для генерации видео:

**1. Webhook (быстро отвечает):**
```php
public function handleVideoGeneration($chatId) {
    // Сохраняем задачу в очередь
    GenerateVideoJob::dispatch($chatId, $prompt);
    
    // Сразу отвечаем пользователю
    $this->telegramService->sendMessage($chatId, "⏳ Генерация началась...");
    
    return; // Webhook завершился быстро!
}
```

**2. Job в очереди (работает в фоне):**
```php
class GenerateVideoJob implements ShouldQueue {
    public function handle() {
        // Долгая генерация видео через Fal.ai
        $video = $this->generateVideo();
        
        // Когда готово - отправляем пользователю
        $this->telegramService->sendMessage($chatId, "✅ Видео готово!");
    }
}
```

## Текущая архитектура вашего бота

### Что работает в webhook (быстро):
- ✅ `/start` - регистрация пользователя
- ✅ Показ баланса
- ✅ Пополнение счета
- ✅ Обработка кнопок

### Что нужно вынести в очереди (когда добавите генерацию):
- ⏳ Генерация видео через Fal.ai
- ⏳ Генерация изображений
- ⏳ Проверка статуса генерации

## Как запустить очереди

```bash
# В фоне обрабатывает задачи из очереди
php artisan queue:work

# Или для разработки
php artisan queue:listen
```

## Итого

✅ **Да, вся логика в webhook - это правильно!**
✅ Но для долгих операций используйте очереди
✅ Webhook должен отвечать быстро (< 1 сек)
✅ Долгие задачи выполняются в фоне через очереди
